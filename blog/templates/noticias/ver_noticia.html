{% extends "index.html" %}

{% block title %}{{ publication.title }}{% endblock title %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <article class="card shadow-sm mb-4">
                <div class="card-body">
                    <h1 class="card-title display-4 text-center mb-3">{{ publication.title }}</h1>
                    <h2 class="card-subtitle h5 text-muted text-center mb-4">{{ publication.subtitle }}</h2>
                    <p class="text-muted text-end fst-italic">
                        Escrito por: <a href="{% url "usuario:user" publication.author.pk %}">{{ publication.author.username }}</a>
                        <br> Publicado el: {{ publication.creation_date|date:"d M, Y" }}
                        {% if publication.last_update %}
                            <br> Actualizado: {{ publication.last_update|date:"d M, Y" }}
                        {% endif %}
                        <br> Categoría: <span class="badge bg-info text-dark">{{ publication.category }}</span>
                    </p>
                    {% if publication.image %}
                    <div class="text-center">
                        <img src="{{ publication.image.image.url }}" class="img-fluid rounded mb-4 w-50" alt="{{ publication.title }}">
                        <p class="opacity-75">{{ publication.image.epigraph }}</p>
                    </div>
                    {% endif %}
                    <hr>
                    <div class="article-body mb-5">
                        {{ publication.body | safe }}
                    </div>

                    <hr>
                    <h3 class="mb-3">Comentarios:</h3>
                    <div id='comments-section' class="mb-4">
                        <!-- Comments will be loaded here via AJAX -->
                    </div>

                    {% if user.is_authenticated %}
                    <div class="card p-3 mb-4">
                        <h5 class="mb-3">Deja un comentario:</h5>
                        <div class="mb-3">
                            <textarea class="form-control" id='new-comment' rows="3" placeholder="Escribe tu comentario aquí..." required></textarea>
                        </div>
                        <button id='send-comment' type="submit" class="btn btn-primary">Comentar</button>    
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center" role="alert">
                        <a href="{% url "usuario:login" %}?next={{ request.path }}" class="alert-link">Inicia sesión</a> para comentar en esta publicación.
                    </div>
                    {% endif %}
                </div>
            </article>

            <div class="text-center mt-4 mb-5">
                <a href="{% url "home" %}" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Volver a la página principal</a>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
    // Obtener el token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Verificar que la coockie corresponda al token
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Obtener comentarios
    function getComments(id) {
        fetch(`/noticias/comentarios/${id}`,{ // Usar la ruta completa
            method : 'GET',
            headers : {
                'X-Requested-With' : 'XMLHttpRequest', //Para comprobar si el request es AJAX
            }
        })
        .then(response => {
            if (!response.ok) {
                // Raise error if invalid response
                throw new Error(`HTTP ERROR - Status: ${response.status}`);
            } else {
                // return response.json()
                // Si se usa httprequest en django se puede utilizar
                return response.text();
            }
        })
        .then(data => {
            // Se completo el request
            commentSection.innerHTML = data;
        })  
        .catch(error=>{
            // Error
            console.error(error)
        });
    }

    // Seleccionar elementos a interactuar
    const commentSection = document.getElementById('comments-section')
    const newComment = document.getElementById('new-comment')
    const sendComment = document.getElementById('send-comment')
    // Obtener el valor de la id de la noticia como lista [noticias, <id>]
    const pathArray = window.location.pathname.split('/');
    const idNoticia = pathArray[pathArray.length - 1]
    // Obtener el csrf_token
    const csrftoken = getCookie('csrftoken');
    
    // Load comments
    document.addEventListener("DOMContentLoaded", ()=> {
        getComments(idNoticia)
    })
    // New comment
    sendComment?.addEventListener('click', (e) => {
        let value = newComment.value;
        if (value.length > 0) {
            fetch(`/noticias/comentarios/${idNoticia}`,{ // Usar la ruta completa
            method : 'POST',
            headers : {
                'X-Requested-With' : 'XMLHttpRequest', //Para comprobar si el request es AJAX
                'X-CSRFToken' : csrftoken
            },
            body : JSON.stringify({ 'comment': value }),
            })
            .then(response => {
                if (!response.ok) {
                    // Raise error if invalid response
                    throw new Error(`HTTP ERROR - Status: ${response.status}`);
                } else {
                    return response.json();
                }
            })
            .then(data => {
                // Se completo el request
                console.log(data);
                // Actualizar los comentarios
                getComments(idNoticia);
                // Vaciar el texto ingresado al input
                newComment.value = '';
            })  
            .catch(error=>{
                // Error
                console.error(error);
            });
        }
    })
</script>
{% endblock scripts %}